From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: Andy Locascio <andy@slack-corp.com>
Date: Wed, 6 May 2020 16:37:54 -0700
Subject: allow in-process windows to have different web prefs

Allow earlier access to newly created WebContents so that we can change
WebPreferences of in-process child windows, rather than relying on
process-level command line switches, as before.

diff --git a/content/public/common/common_param_traits_macros.h b/content/public/common/common_param_traits_macros.h
index ba371f4a80e821c96fa00e9b9b405894c1b67a90..7f0d676833ea1e396896d1aea7727556bfa3247b 100644
--- a/content/public/common/common_param_traits_macros.h
+++ b/content/public/common/common_param_traits_macros.h
@@ -132,6 +132,28 @@ IPC_STRUCT_TRAITS_BEGIN(blink::web_pref::WebPreferences)
   IPC_STRUCT_TRAITS_MEMBER(webgl2_enabled)
   IPC_STRUCT_TRAITS_MEMBER(pepper_3d_enabled)
   IPC_STRUCT_TRAITS_MEMBER(record_whole_document)
+
+  IPC_STRUCT_TRAITS_MEMBER(preloads)
+  IPC_STRUCT_TRAITS_MEMBER(disable_electron_site_instance_overrides)
+  IPC_STRUCT_TRAITS_MEMBER(background_color)
+  IPC_STRUCT_TRAITS_MEMBER(opener_id)
+  IPC_STRUCT_TRAITS_MEMBER(context_isolation)
+  IPC_STRUCT_TRAITS_MEMBER(enable_remote_module)
+  IPC_STRUCT_TRAITS_MEMBER(world_safe_execute_javascript)
+  IPC_STRUCT_TRAITS_MEMBER(guest_instance_id)
+  IPC_STRUCT_TRAITS_MEMBER(hidden_page)
+  IPC_STRUCT_TRAITS_MEMBER(offscreen)
+  IPC_STRUCT_TRAITS_MEMBER(preload)
+  IPC_STRUCT_TRAITS_MEMBER(native_window_open)
+  IPC_STRUCT_TRAITS_MEMBER(node_integration)
+  IPC_STRUCT_TRAITS_MEMBER(node_integration_in_worker)
+  IPC_STRUCT_TRAITS_MEMBER(node_leakage_in_renderers)
+  IPC_STRUCT_TRAITS_MEMBER(node_integration_in_sub_frames)
+  IPC_STRUCT_TRAITS_MEMBER(enable_spellcheck)
+  IPC_STRUCT_TRAITS_MEMBER(enable_plugins)
+  IPC_STRUCT_TRAITS_MEMBER(enable_websql)
+  IPC_STRUCT_TRAITS_MEMBER(webview_tag)
+
   IPC_STRUCT_TRAITS_MEMBER(flash_3d_enabled)
   IPC_STRUCT_TRAITS_MEMBER(flash_stage3d_enabled)
   IPC_STRUCT_TRAITS_MEMBER(flash_stage3d_baseline_enabled)
diff --git a/third_party/blink/common/web_preferences/web_preferences.cc b/third_party/blink/common/web_preferences/web_preferences.cc
index 940721ccb3f6cea6ad0ffdc71e0975a085b4fda7..1dfca6e5007759af22cf1e5b833e138e4f45a78e 100644
--- a/third_party/blink/common/web_preferences/web_preferences.cc
+++ b/third_party/blink/common/web_preferences/web_preferences.cc
@@ -158,6 +158,28 @@ WebPreferences::WebPreferences()
       navigate_on_drag_drop(true),
       v8_cache_options(blink::mojom::V8CacheOptions::kDefault),
       record_whole_document(false),
+
+      preloads(base::FilePath::StringType()),
+      disable_electron_site_instance_overrides(),
+      background_color(base::EmptyString()),
+      opener_id(0),
+      context_isolation(false),
+      enable_remote_module(false),
+      world_safe_execute_javascript(false),
+      guest_instance_id(0),
+      hidden_page(false),
+      offscreen(false),
+      preload(base::FilePath::StringType()),
+      native_window_open(false),
+      node_integration(false),
+      node_integration_in_worker(false),
+      node_leakage_in_renderers(false),
+      node_integration_in_sub_frames(false),
+      enable_spellcheck(false),
+      enable_plugins(false),
+      enable_websql(false),
+      webview_tag(false),
+
       cookie_enabled(true),
       accelerated_video_decode_enabled(false),
       animation_policy(kImageAnimationPolicyAllowed),
diff --git a/third_party/blink/public/common/web_preferences/web_preferences.h b/third_party/blink/public/common/web_preferences/web_preferences.h
index 09fbf0fac9c880c2bd64446611efe4debc000767..0e2a2eb9ed70a3cd133c5347652bb96d0e507732 100644
--- a/third_party/blink/public/common/web_preferences/web_preferences.h
+++ b/third_party/blink/public/common/web_preferences/web_preferences.h
@@ -9,6 +9,7 @@
 #include <string>
 #include <vector>
 
+#include "base/files/file_path.h"
 #include "base/strings/string16.h"
 #include "base/time/time.h"
 #include "build/build_config.h"
@@ -165,6 +166,27 @@ struct BLINK_COMMON_EXPORT WebPreferences {
   blink::mojom::V8CacheOptions v8_cache_options;
   bool record_whole_document;
 
+  base::FilePath::StringType preloads;
+  bool disable_electron_site_instance_overrides;
+  std::string background_color;
+  int opener_id;
+  bool context_isolation;
+  bool enable_remote_module;
+  bool world_safe_execute_javascript;
+  int guest_instance_id;
+  bool hidden_page;
+  bool offscreen;
+  base::FilePath::StringType preload;
+  bool native_window_open;
+  bool node_integration;
+  bool node_integration_in_worker;
+  bool node_leakage_in_renderers;
+  bool node_integration_in_sub_frames;
+  bool enable_spellcheck;
+  bool enable_plugins;
+  bool enable_websql;
+  bool webview_tag;
+
   // This flags corresponds to a Page's Settings' setCookieEnabled state. It
   // only controls whether or not the "document.cookie" field is properly
   // connected to the backing store, for instance if you wanted to be able to
